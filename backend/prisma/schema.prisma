// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  // output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  // provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  GESTIONNAIRE
  ADMIN
}

enum TypeClient {
  SIMPLE
  PEINTRE
}

enum UniteMesure {
  KG
  PIECE
}

enum Statut {
  VALIDE
  RETOURNE_PARTIEL
  RETOURNE_TOTAL
}

enum TypeRetour {
  PARTIEL
  TOTAL
}

// ============================================
// USERS
// ============================================
model Utilisateur {
  id        Int      @id @default(autoincrement())
  nom       String
  prenom    String?
  email     String?   @unique
  password  String
  role      Role     @default(GESTIONNAIRE)
  actif     Boolean  @default(true)
  lastLogin DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  achats    Achat[]
  retours   Retour[]

  @@map("utilisateurs")
}

// ============================================
// CLIENTS
// ============================================
model Client {
  id        Int        @id @default(autoincrement())
  nom       String
  prenom    String?
  email     String?    @unique
  telephone String?    @unique
  adresse   String?
  type      TypeClient @default(SIMPLE)
  actif     Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  achats    Achat[]
  retours   Retour[]

  @@map("clients")
}

// ============================================
// BRANDS
// ============================================
model Marque {
  id          Int      @id @default(autoincrement())
  nom         String   @unique
  image       String?
  description String?
  actif       Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  produits    Produit[]

  @@map("marques")
}

// ============================================
// CATEGORIES
// ============================================
model Categorie {
  id          Int      @id @default(autoincrement())
  nom         String   @unique
  description String?
  actif       Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  image       String? 
  produits    Produit[]

  @@map("categories")
}

// ============================================
// PRODUCTS
// ============================================
model Produit {
  id                      Int          @id @default(autoincrement())
  reference               String       @unique
  nom                     String
  description             String?
  image                   String?
  prixUnitaire            Float
  prixTotal               Float
  poids                   Float?       
  uniteMesure             UniteMesure  @default(PIECE)
  quantite_depos          Float        @default(0)
  quantite_stock          Float        @default(0)
  seuilAlerte             Float        @default(5)
  venduParUnite           Boolean      @default(true) // true = can sell partial (5.5kg), false = whole units only
  actif                   Boolean      @default(true)
  deleted                 Boolean      @default(false)
  marqueId                Int
  categorieId             Int
  
  marque                  Marque       @relation(fields: [marqueId], references: [id])
  categorie               Categorie    @relation(fields: [categorieId], references: [id])
  
  ligneAchats             LigneAchat[]
  ligneRetours            LigneRetour[]
  //lot de stock 
  date_expiration         DateTime?
  createdAt               DateTime     @default(now())
  updatedAt               DateTime     @updatedAt

  @@map("produits")
}

// ============================================
// PURCHASES (ACHATS)
// ============================================
model Achat {
  id              Int      @id @default(autoincrement())
  numeroBon       String   @unique // e.g., "BON-1761693329470"
  clientId        Int
  utilisateurId   Int
  prix_total       Float
  remiseGlobale   Float    @default(0)
  prix_total_remise      Float
  statut          Statut   @default(VALIDE)
  dateAchat       DateTime @default(now())
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  // versment        Float

  client          Client      @relation(fields: [clientId], references: [id])
  utilisateur     Utilisateur @relation(fields: [utilisateurId], references: [id])
  
  ligneAchats     LigneAchat[]
  retours         Retour[]

  @@map("achats")
}

// ============================================
// PURCHASE LINES (LIGNES ACHATS)
// ============================================
model LigneAchat {
  id                  Int      @id @default(autoincrement())
  achatId             Int
  produitId           Int
  quantite            Float
  quantiteRetournee   Float    @default(0)
  prixUnitaire        Float
  remise              Float    @default(0)
  sousTotal           Float
  createdAt           DateTime @default(now())

  achat               Achat       @relation(fields: [achatId], references: [id], onDelete: Cascade)
  produit             Produit     @relation(fields: [produitId], references: [id])
  
  ligneRetours        LigneRetour[]

  @@map("lignes_achats")
}

// ============================================
// RETURNS (RETOURS)
// ============================================
model Retour {
  id                Int         @id @default(autoincrement())
  numeroRetour      String      @unique // e.g., "RET-1761800000000"
  achatId           Int
  clientId          Int
  utilisateurId     Int
  montantRembourse  Float
  typeRetour        TypeRetour
  motif             String?
  dateRetour        DateTime    @default(now())
  createdAt         DateTime    @default(now())

  achat             Achat       @relation(fields: [achatId], references: [id])
  client            Client      @relation(fields: [clientId], references: [id])
  utilisateur       Utilisateur @relation(fields: [utilisateurId], references: [id])
  
  ligneRetours      LigneRetour[]

  @@map("retours")
}

// ============================================
// RETURN LINES (LIGNES RETOURS)
// ============================================
model LigneRetour {
  id                  Int      @id @default(autoincrement())
  retourId            Int
  ligneAchatId        Int
  produitId           Int
  quantiteRetournee   Float
  montantLigne        Float
  motifDetaille       String?
  createdAt           DateTime @default(now())

  retour              Retour      @relation(fields: [retourId], references: [id], onDelete: Cascade)
  ligneAchat          LigneAchat  @relation(fields: [ligneAchatId], references: [id])
  produit             Produit     @relation(fields: [produitId], references: [id])

  @@map("lignes_retours")
}